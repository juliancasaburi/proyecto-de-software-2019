{% extends "layout.html" %}
{% block title %}Listado de Usuarios - {{ siteconfig['titulo'] }}{% endblock %}
{% block head %}
    {{ super() }}
    <meta id="items-per-page" data-ammount="{{ siteconfig['items_por_pagina'] }}">
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.material.min.css') }}" media="screen">
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/responsive.dataTables.min.css') }}" media="screen">
{% endblock %}

{% block main %}
    <div class="container">
        <div class="section">

            <div class="row">
                <div class="col s12 center">
                    <h1>Listado de Usuarios</h1>
                </div>
            </div>

            {% if users %}
                <div class="row">
                    <div class="card material-table">
                        <div class="table-header">
                            <span class="table-title">Usuarios</span>
                            <div class="actions">
                                <a class="tooltipped modal-trigger waves-effect btn-flat nopadding" href="#modalAltaUsuario" data-position="top" data-tooltip="Alta Usuario"><i class="material-icons">person_add</i></a>
                                <a class="tooltipped modal-trigger btn-flat nopadding" href="#modalFilters" data-position="top" data-tooltip="Filtros">
                                    <i class="large material-icons">search</i>
                                </a>
                            </div>
                        </div>
                        <table id="tablaUsuarios" class="highlight nowrap" style="width:100%">
                            <thead>
                            <tr class="orange">
                                {% for key in users[0] %}
                                    <th> {{ key }} </th>
                                {% endfor %}
                                <th class="nosort">Editar</th>
                                <th class="nosort">Baja</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for dict_item in users %}
                                <tr>
                                    {% for value in dict_item.values() %}
                                        <td class="{{ value }}"> {{ value }} </td>
                                    {% endfor %}
                                    <td><a id="{{ dict_item.ID }}" class="editButton btn blue-grey"><i class="fas fa-edit"></i></a></td>
                                    <td><a id="{{ dict_item.ID }}" class="deleteButton btn red"><i class="material-icons">cancel</i></a></td>
                                </tr>
                            {% endfor %}
                            </tbody>
                            <tfoot>
                            <tr class="orange">
                                <th>Editar</th>
                                {% for key in users[0] %}
                                    <th> {{ key }} </th>
                                {% endfor %}
                                <th>Baja</th>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                {% include 'partials/modal_alta_usuario.html' %}
                {% include 'partials/modal_editar_usuario.html' %}

                <div class="col-md-12 center text-center">
                    <span class="left" id="total_reg"></span>
                    <ul class="pagination pager" id="pager"></ul>
                </div>

                <div class="fixed-action-btn">
                    <a class="btn-floating btn-large tooltipped modal-trigger teal waves-effect waves-light" href="#modalFilters" data-position="left" data-tooltip="Filtros">
                        <i class="large material-icons">search</i>
                    </a>
                </div>

                <!-- Modal Structure -->
                <div id="modalFilters" class="modal bottom-sheet modal-fixed-footer">
                    <div class="modal-content">
                        <h3 class="header">Filtrar el listado de Usuarios</h3>
                        <ul class="collection">
                            <li class="collection-item">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">account_circle</i>
                                    <input class="filterUsuario" id="filterUsuario" type="text">
                                    <label for="filterUsuario">Filtrar por Usuario</label>
                                </div>
                            </li>
                            <li class="collection-item">
                                <p>
                                    <label>
                                        <input id="filterActive" type="checkbox" checked="checked"/>
                                        <span>Listar usuarios bloqueados</span>
                                    </label>
                                </p>
                            </li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <a class="modal-action modal-close waves-effect waves-teal btn-flat">Cerrar</a>
                    </div>
                </div>

            {% endif %}

        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dataTables.responsive.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dataTables.material.min.js') }}"></script>
    <script> // Search tooltip
    $(document).ready(function(){
        $('.tooltipped').tooltip();
    });
    </script>
    <script>
        $(document).ready(function() {
            $('#tablaUsuarios').DataTable( {
                "language": {
                    "paginate": {
                        "first":      "Primera",
                        "last":       "Ãšltima",
                        "next":       "Siguiente",
                        "previous":   "Anterior"
                    },
                    "info":           "Mostrando resultados _START_ al _END_ de un total de _TOTAL_",
                    "infoFiltered": "<br>(_MAX_ sin filtrar)"
                },
                "columnDefs": [
                    { "orderable": false, "targets": 'nosort' } // Disable sorting for column 9
                ],
                sDom: 't,i,p', // Hide info
                pageLength: $('#items-per-page').data("ammount"),
                "scrollX": true
            } );
        } );
    </script>
    <script>
        $(document).ready(function(){
            var table = $('#tablaUsuarios').DataTable();
            $(".filterUsuario").on("keyup", function() {
                table
                    .columns( 5 )
                    .search( this.value )
                    .draw();
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            $("#filterActive").on("change", function(){
                var table = $('#tablaUsuarios').DataTable();
                if($("#filterActive").prop("checked") == true)
                {
                    $.fn.dataTable.ext.search.pop();
                    table.draw('full-hold');

                }
                else
                {
                    /* Custom filtering function which will search data in column 1 */
                    $.fn.dataTable.ext.search.push(
                        function( settings, data, dataIndex ) {
                            if (data[1] == 0)
                            {
                                return false;
                            }
                            return true;
                        }
                    );
                    table.draw('full-hold');
                }
            });
        });
    </script>
    <script>
        $('#modalFilters').modal({
                dismissible: true, // Modal can be dismissed by clicking outside of the modal
                opacity: .5, // Opacity of modal background
                inDuration: 300, // Transition in duration
                outDuration: 200, // Transition out duration
                startingTop: '4%', // Starting top style attribute
                endingTop: '10%', // Ending top style attribute
                ready: function(modal, trigger) { // Callback for Modal open. Modal and trigger parameters available.
                    //  alert("Ready");
                    console.log(modal, trigger);
                },
                complete: function() { //alert('Closed');
                } // Callback for Modal close
            }
        );
    </script>
    <script> // Alta de Usuario
    $(document).ready(function(){
        $('#modalAltaUsuario').modal();
        $('#modalEditarUsuario').modal({
                onCloseStart: function() { // Callback for Modal close
                    $.ajax({
                        type: "GET",
                        url: "{{ url_for('roles') }}",
                        success: function (response) {
                            for (var key in response){
                                $("#select_roles option[value='" + response[key]['id'] + "']").prop("selected", false);
                                $("#select_roles").formSelect();
                            }
                        },
                        error: function (jqXhr, textStatus, errorMessage) {
                            console.log("Error: ", errorMessage);
                        }
                    });
                }
            }
        );
        $('select').formSelect();
    });
    </script>
    <script>
        // Delete a record
        $('.deleteButton').on('click', function (e) {
            var btn = $(this);
            var btn_id = $(this).attr('id');
            if (confirm("Eliminar usuario con ID:" + btn_id) == true) {
                $.ajax({
                    type: "POST",
                    url: "{{ url_for('user_destroy') }}",
                    data: JSON.stringify({"id": btn_id}),
                    dataType: 'json',
                    contentType: 'application/json;charset=UTF-8',
                    success: function () {
                        var table = $('#tablaUsuarios').DataTable();
                        table.row($(btn).parents('tr')).remove().draw('full-hold');
                        var toastText = "El usuario con ID: " + btn_id + " fue eliminado";
                        M.toast({html: toastText, classes: 'green'});
                    },
                    error: function (jqXhr, textStatus, errorMessage) {
                        console.log("Error: ", errorMessage);
                    }
                });
            }
        });
    </script>
    <script>
        // Edit a record
        $('.editButton').on('click', function (e) {
            var table = $('#tablaUsuarios').DataTable();
            var row = table.row($(this).parents("tr"));
            var data = row.data();
            var uname = data[5];
            $.ajax({
                type: "POST",
                url: "{{ url_for('user') }}",
                data: JSON.stringify({"username": uname}),
                dataType: 'json',
                contentType: 'application/json;charset=UTF-8',
                success: function (response) {
                    for (var key in response['roles']){
                        $("#select_roles option[value='" + response['roles'][key]['id'] + "']").prop("selected", true);
                    }
                    $('#modal_editar_id').val(response['id']);
                    $('#modal_editar_activo').prop('checked', response['activo']);
                    $('#modal_editar_nombre').attr("placeholder", response['first_name']);
                    $('#modal_editar_nombre').attr("value", response['first_name']);
                    $('#modal_editar_apellido').attr("placeholder", response['last_name']);
                    $('#modal_editar_apellido').attr("value", response['last_name']);
                    $('#modal_editar_email').attr("placeholder", response['email']);
                    $('#modal_editar_email').attr("value", response['email']);
                    $('#modal_editar_username').attr("placeholder", response['username']);
                    $('#modal_editar_username').attr("value", response['username']);
                    M.updateTextFields();
                    $('#modalEditarUsuario').modal('open');
                },
                error: function (jqXhr, textStatus, errorMessage) {
                    console.log("Error: ", errorMessage);
                }
            });
        });
    </script>
    <script>
        $(document).ready(function(){
            var frm = $('#formEditarUsuario');

            frm.submit(function (e) {
                e.preventDefault();
                $('#modalEditarUsuario').modal('close');
                $.ajax({
                    type: frm.attr('method'),
                    url: frm.attr('action'),
                    data: frm.serialize(),
                    error: function (data) {
                        console.log('Error');
                        console.log(data);
                    },
                });
            });
        });
    </script>
{% endblock %}