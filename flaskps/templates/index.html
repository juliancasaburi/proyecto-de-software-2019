{% extends "layout.html" %}
{% block title %}{{ siteconfig['titulo'] }}{% endblock %}
{% block head %}
    {{ super() }}
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}" media="screen">
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/ol.css') }}" media="screen">
{% endblock %}

{% block main %}
    <div id="index-banner" class="parallax-container valign-wrapper">
        <div class="container">
            <div class="row">
                <h1 class="center parallax-title white-text wow zoomIn" data-wow-duration="4s">Orquesta Escuela de Berisso</h1>
            </div>
        </div>
        <div class="parallax"><img src="{{ url_for('static', filename='img/parallax.jpeg') }}" alt="Imagen de fondo"></div>
    </div>

    <div class="about">
        <div class="container wow slideInUp z-depth-3">
            <div class="section" style="background: #f9f9f9">
                <div class="row wow fadeIn">
                    <div class="col s12 index">
                        <div class="col s6 right-align wow fadeIn" data-wow-delay="1s">
                            <div class="col s12">
                                <h6 class="light">Con esta página web vas a poder administrar toda la información de los <span class="orange-text">alumnos</span>, <span class="orange-text">docentes</span> y <span class="orange-text">preceptores</span>.</h6>
                            </div>
                            <div class="col s12">

                            </div>
                        </div>
                        <div class="col s6 wow zoomIn" data-wow-delay="0.5s">
                            <div class="row center">
                                <i class="material-icons fa-4x blue-text">build</i>
                                <h4>Acerca de esta herramienta</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="divider"></div>
            <div class="section">
                <!--   Icon Section   -->
                <div class="row">
                    <div class="col s12 index">
                        <div class="col s6 right-align wow zoomIn" data-wow-delay="0.5s">
                            <div class="row center">
                                <i class="material-icons fa-4x blue-text">flag</i>
                                <h4>Inicios de la Escuela</h4>
                            </div>
                        </div>
                        <div class="col s6 left-align wow fadeIn" data-wow-delay="1s">
                            <h6 class="light">La Orquesta Escuela de Berisso comenzó a funcionar en septiembre del <span class="orange-text">2005</span> en el barrio de <span class="orange-text">El Carmen</span> de la localidad de <span class="orange-text">Berisso</span> bajo la dirección del Mtro. Juan Carlos Herrero, orientada especialmente a la atención de chicos en situación de <span class="orange-text">vulnerabilidad socio-cultural</span>.</h6>
                        </div>
                    </div>
                </div>
            </div>
            <div class="divider"></div>
            <div class="section" style="background: #f9f9f9">
                <div class="row">
                    <div class="col s12 index">
                        <div class="col s6 right-align wow fadeIn" data-wow-delay="0.2s">
                            <h6 class="light">Desde sus 20 alumnos iniciales fue creciendo hasta atender actualmente una matrícula de aproximadamente <span class="orange-text">530</span> chicos.</h6>
                        </div>
                        <div class="col s6 wow zoomIn">
                            <div class="row left-align center">
                                <i class="material-icons fa-4x blue-text">school</i>
                                <h4 class="center">Nuestros alumnos</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="divider blue"></div>

    <div class="carousel carousel-slider orange darken-4">
        <a class="carousel-item center"><img class="img-responsive" src="{{ url_for('static', filename='img/carousel1.jpg') }}" alt="Primera imagen del carousel"></a>
        <a class="carousel-item center"><img class="img-responsive" src="{{ url_for('static', filename='img/carousel2.jpg') }}" alt="Segunda imagen del carousel"></a>
        <a class="carousel-item center"><img class="img-responsive" src="{{ url_for('static', filename='img/carousel3.jpg') }}" alt="Tercera imagen del carousel"></a>
        <a class="carousel-item center"><img class="img-responsive" src="{{ url_for('static', filename='img/carousel4.jpg') }}" alt="Cuarda imagen del carousel"></a>
        <a class="carousel-item center"><img class="img-responsive" src="{{ url_for('static', filename='img/carousel5.jpg') }}" alt="Quinta imagen del carousel"></a>
    </div>

    <div class="divider blue"></div>

    <div class="container">
        <div class="section">
            <div class="row">
                <div class="col s12 center wow fadeInUp">
                    <h1 class="light-blue-text text-darken-2">¡Sumate!</h1>
                    <p class="text-justify light">{{ siteconfig['descripcion'] }}</p>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="section">
            <div class="row center wow fadeInUp">
                <h1 class="header blue-text col s12">Núcleos en los que trabajamos</h1>
                <h6 class="col s12">Esta es una lista de los núcleos donde actualmente estamos trabajando, puede verlos en el mapa</h6>
            </div>

            <div class="row" style="margin-bottom: 2rem">
                <div class="input-field col s12 wow fadeIn" data-wow-delay="1.25s">
                    <select id="map-select">
                        <option value="" disabled selected>Elija el núcleo</option>
                    </select>
                    <label for="map-select">Quiero saber la ubicación de...</label>
                </div>
            </div>

            <div class="row">
                <div id="map" class="col s10 offset-s1 z-depth-4 wow zoomIn" data-wow-delay="0.5s" style="height:300px"></div>
                <div id="feature-info" class="feature-info container z-depth-2"></div>
            </div>
        </div>
    </div>


{% endblock %}

{% block scripts %}
    <!-- Animations -->
    <script src="{{ url_for('static', filename='js/wow.min.js') }}"></script>
    <script>
        $(document).ready(function() {
            $('select').formSelect();
            new WOW({
                live: true
            }).init();
            $('.parallax').parallax();
            $('.carousel.carousel-slider').carousel({
                fullWidth: true,
                indicators: true
            });
        });
    </script>
    <!-- OpenLayers -->
    <script src="{{ url_for('static', filename='js/ol.js') }}"></script>
    <script>
        $(document).ready(function(){
            // get nucleos activos
            var nucleos;
            $.ajax({
                type: "GET",
                url: "{{ url_for('nucleo_activos') }}",
                success: function (response) {
                    nucleos = response;
                    nucleos_markers = [];
                    for (var i=0; i<nucleos.length; i++) {
                        $('#map-select').append("<option value='"+ i + "'>" + nucleos[i]['nombre'] + "</option>");
                        // markers
                        nucleos_markers[i] = new ol.Feature({
                            geometry: new ol.geom.Point(
                                ol.proj.fromLonLat([nucleos[i]['lng'],nucleos[i]['lat']])
                            ),
                            nucleo_pos: i
                        });
                        // add marker
                        nucleos_markers[i].setStyle(
                            new ol.style.Style({
                                image: new ol.style.Icon({
                                    anchor: [0.5, 0.0],
                                    color: 'red',
                                    crossOrigin: 'anonymous',
                                    anchorOrigin: 'bottom-left',
                                    scale: 0.4,
                                    src: '{{ url_for('static', filename='img/location-on.png') }}'
                                }),
                            })
                        );
                    }

                    $('#map-select').val("");
                    $('#map-select').formSelect();

                    var zoom = 15;

                    var escuela_25 = [-57.89335, -34.92595];

                    var info = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat(escuela_25)),
                        name: 'Escuela 25'
                    });
                    var iconStyle = new ol.style.Style({
                        image: new ol.style.Icon({
                            crossOrigin: 'anonymous',
                            src: '{{ url_for('static', filename='img/escuela.png') }}'
                        })
                    });

                    var vectorSource = new ol.source.Vector({
                        features: [info]
                    });

                    var vectorSourceMarkers = new ol.source.Vector({
                        features: nucleos_markers
                    });

                    var map = new ol.Map({
                        target: 'map',
                        layers: [
                            new ol.layer.Tile({
                                source: new ol.source.OSM()
                            }),
                            new ol.layer.Vector({
                                source: vectorSource,
                                updateWhileAnimating: true,
                                updateWhileInteracting: true,
                                style: function(feature, resolution) {
                                    iconStyle.getImage().setScale(1/Math.pow(resolution, 1/6));
                                    return iconStyle;
                                }
                            }),
                            // layer para markers
                            new ol.layer.Vector({
                                source: vectorSourceMarkers
                            })
                        ],
                        view: new ol.View({
                            center: ol.proj.fromLonLat(escuela_25),
                            zoom: zoom
                        }),
                        controls: new ol.control.defaults().extend([
                            new ol.control.Rotate(),
                            new ol.control.OverviewMap(),
                            new ol.control.ZoomToExtent(),
                            new ol.control.ScaleLine(),
                            new ol.control.ZoomSlider()
                        ])
                    });

                    // marker onhover
                    var feature_onPointerMove;
                    var feature_info = document.getElementById('feature-info');
                    var feature_info_jquery = $('#feature-info');
                    var overlay = new ol.Overlay({
                        element: feature_info,
                        offset: [0, 0]
                    });
                    map.addOverlay(overlay);

                    map.on('pointermove', function(evt) {
                        feature_onPointerMove = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                            if (feature != info) return feature;
                        });

                        if (feature_onPointerMove) {
                            overlay.setPosition(evt.coordinate);

                            // texto dentro del feature
                            feature_info_jquery.show();
                            var nucleo = nucleos[feature_onPointerMove.getProperties()['nucleo_pos']];
                            var tel = nucleo['telefono'];
                            if (nucleo['telefono'] == '') tel = 'no registrado';
                            feature_info.innerHTML =
                                '<div style="margin-bottom: auto" class="row">' +
                                    '<div class="col s12 center-align">' +
                                        '<span><b>' + nucleo['nombre'] + '</b></span>' +
                                    '</div>' +
                                    '<div class="divider-feature-info div-transparent col s12"></div>' +
                                    '</div class="col s12 center-align">' +
                                        '<span><i style="font-size: small" class="material-icons">label</i> Teléfono: ' + tel + '</span>' +
                                    '</div>' +
                                '</div>';

                            // ajustar posición del feature-info
                            var coords = feature_onPointerMove.getGeometry().getCoordinates();
                            var pixel = map.getPixelFromCoordinate(coords);
                            var map_size = map.getSize();
                            if ((pixel[0] < map_size[0]/2) && (pixel[1] < map_size[1]/2)) {
                                overlay.setOffset([0, 0]);
                                overlay.setPositioning('top-left');
                            }
                            else if ((pixel[0] < map_size[0]/2) && (pixel[1] > map_size[1]/2)) {
                                overlay.setOffset([0, 0]);
                                overlay.setPositioning('bottom-left');
                            }
                            else if ((pixel[0] > map_size[0]/2) && (pixel[1] < map_size[1]/2)) {
                                overlay.setOffset([feature_info.offsetWidth/2, 0]);
                                overlay.setPositioning('top-right');
                            }
                            else if ((pixel[0] > map_size[0]/2) && (pixel[1] > map_size[1]/2)) {
                                overlay.setOffset([feature_info.offsetWidth/2, 0]);
                                overlay.setPositioning('bottom-right');
                            }
                        }
                        else feature_info_jquery.hide();
                    });

                    // mover posición al núcleo seleccinado en el select
                    $('#map-select').on('change', function() {
                        var coords = [nucleos[parseInt($(this).val())]['lng'], nucleos[parseInt($(this).val())]['lat']];
                        map.getView().animate({
                            center: ol.proj.fromLonLat(coords),
                            duration: 2000,
                            zoom: zoom
                        })
                    });

                },
                error: function (jqXhr, textStatus, errorMessage) {
                    console.log("Error: ", errorMessage);
                }
            });


        });
    </script>
{% endblock %}